{"version":3,"file":"auth.decorator.js","sourceRoot":"","sources":["../../../src/providers/auth.decorator.ts"],"names":[],"mappings":"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","sourcesContent":["import { Subject } from 'rxjs';\nimport Amplify, { Logger, Hub } from 'aws-amplify';\nimport { AuthState } from './auth.state';\nimport * as _ from 'lodash';\n\nconst logger = new Logger('AuthDecorator');\n\nfunction check(authState: Subject<AuthState>) {\n  // check for current authenticated user to init authState\n  Amplify.Auth.currentAuthenticatedUser()\n    .then(user => {\n      logger.debug('has authenticated user', user);\n      authState.next({ state: 'signedIn', user });\n    })\n    .catch(err => {\n      logger.debug('no authenticated user', err);\n      authState.next({ state: 'signedOut', user: null });\n    });\n}\n\nfunction listen(authState: Subject<AuthState>) {\n  const config = Amplify.configure(null);\n  if (_.has(config, 'Auth.oauth')) {\n    Hub.listen('auth', {\n      onHubCapsule: capsule => {\n        const { channel, payload } = capsule;\n        if (channel === 'auth') {\n          const { username } = payload.data;\n          logger.debug('authentication oauth event', payload);\n          authState.next({ state: payload.event, user: { username} });\n        }\n      }\n    },         'angularAuthListener');\n  }\n}\n\nfunction decorateSignIn(authState: Subject<AuthState>) {\n  const _signIn = Amplify.Auth.signIn;\n  Amplify.Auth.signIn = (\n    username: string,\n    password: string\n  ): Promise<any> => {\n    return _signIn.call(Amplify.Auth, username, password)\n      .then(user => {\n        logger.debug('signIn success');\n        if (!user.challengeName) {\n          authState.next({ state: 'signedIn', user });\n          return user;\n        }\n\n        logger.debug('signIn challenge: ' + user.challengeName);\n        if (user.challengeName === 'NEW_PASSWORD_REQUIRED') {\n          authState.next({ state: 'requireNewPassword', user });\n        } else if (user.challengeName === 'MFA_SETUP') {\n          authState.next({ state: 'setupMFA', user });\n        } else if (\n          user.challengeName === 'SMS_MFA' ||\n          user.challengeName === 'SOFTWARE_TOKEN_MFA'\n        ) {\n          authState.next({ state: 'confirmSignIn', user });\n        } else {\n          logger.debug('warning: unhandled challengeName ' + user.challengeName);\n        }\n        return user;\n      })\n      .catch(err => {\n        logger.debug('signIn error', err);\n        throw err;\n      });\n  };\n}\n\nfunction decorateSignOut(authState: Subject<AuthState>) {\n  const _signOut = Amplify.Auth.signOut;\n  Amplify.Auth.signOut = (): Promise<any> => {\n    return _signOut.call(Amplify.Auth)\n      .then(data => {\n        logger.debug('signOut success');\n        authState.next({ state: 'signedOut', user: null });\n        return data;\n      })\n      .catch(err => {\n        logger.debug('signOut error', err);\n        throw err;\n      });\n  };\n}\n\nfunction decorateSignUp(authState: Subject<AuthState>) {\n  const _signUp = Amplify.Auth.signUp;\n  Amplify.Auth.signUp = (\n    username: string,\n    password: string,\n    email: string,\n    phone_number: string\n  ): Promise<any> => {\n    return _signUp.call(Amplify.Auth, username, password, email, phone_number)\n      .then(data => {\n        logger.debug('signUp success');\n        authState.next({ state: 'confirmSignUp', user: { username }});\n        return data;\n      })\n      .catch(err => {\n        logger.debug('signUp error', err);\n        throw err;\n      });\n  };\n}\n\nfunction decorateConfirmSignUp(authState: Subject<AuthState>) {\n  const _confirmSignUp = Amplify.Auth.confirmSignUp;\n  Amplify.Auth.confirmSignUp = (\n    username: string,\n    code: string\n  ): Promise<any> => {\n    return _confirmSignUp.call(Amplify.Auth, username, code)\n      .then(data => {\n        logger.debug('confirmSignUp success');\n        authState.next({ state: 'signIn', user: { username }});\n        return data;\n      })\n      .catch(err => {\n        logger.debug('confirmSignUp error', err);\n        throw err;\n      });\n  };\n}\n\nexport function authDecorator(authState: Subject<AuthState>) {\n  check(authState);\n  listen(authState);\n\n  decorateSignIn(authState);\n  decorateSignOut(authState);\n  decorateSignUp(authState);\n  decorateConfirmSignUp(authState);\n}\n"]}